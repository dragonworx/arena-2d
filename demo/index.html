<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Arena-2D — Demo</title>
  <link rel="stylesheet" href="style.css">
  <!-- PrismJS for syntax highlighting -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css">
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <h1>Arena-2D</h1>
      <div class="version">v0.0.1 — Demo</div>
    </div>
    <nav class="nav">
      <div class="nav-section">
        <div class="nav-section-title">Foundation</div>
        <a class="nav-link active" data-panel="layer-1">
          <span class="nav-dot"></span> Layer 1 — Transform
        </a>
        <a class="nav-link" data-panel="layer-1.1">
          <span class="nav-dot"></span> Layer 1.1 — Geometry
        </a>
        <a class="nav-link" data-panel="layer-1.2">
          <span class="nav-dot"></span> Layer 1.2 — Composite
        </a>
        <a class="nav-link" data-panel="layer-2">
          <span class="nav-dot"></span> Layer 2 — Events
        </a>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">Core</div>
        <a class="nav-link" data-panel="layer-3">
          <span class="nav-dot"></span> Layer 3 — Elements
        </a>
        <a class="nav-link" data-panel="layer-4">
          <span class="nav-dot"></span> Layer 4 — Containers
        </a>
        <a class="nav-link" data-panel="layer-5">
          <span class="nav-dot"></span> Layer 5 — Ticker
        </a>
        <a class="nav-link" data-panel="layer-5.1">
          <span class="nav-dot"></span> Layer 5.1 — Tween
        </a>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">Rendering</div>
        <a class="nav-link" data-panel="layer-6">
          <span class="nav-dot"></span> Layer 6 — Context
        </a>
        <a class="nav-link" data-panel="layer-7">
          <span class="nav-dot"></span> Layer 7 — Scene
        </a>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">Features</div>
        <a class="nav-link" data-panel="layer-8">
          <span class="nav-dot"></span> Layer 8 — Layout
        </a>
        <a class="nav-link" data-panel="layer-9">
          <span class="nav-dot"></span> Layer 9 — Interaction
        </a>
        <a class="nav-link" data-panel="layer-9.1">
          <span class="nav-dot"></span> Layer 9.1 — Hit Test Perf
        </a>
        <a class="nav-link" data-panel="layer-10">
          <span class="nav-dot"></span> Layer 10 — Text
        </a>
        <a class="nav-link" data-panel="layer-11">
          <span class="nav-dot"></span> Layer 11 — Text Input
        </a>
        <a class="nav-link" data-panel="layer-12">
          <span class="nav-dot"></span> Layer 12 — Images
        </a>
        <a class="nav-link" data-panel="layer-13">
          <span class="nav-dot"></span> Layer 13 — Scroll
        </a>
      </div>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="main">

    <!-- Layer 1 Panel -->
    <div id="layer-1" class="panel">

    </div>

    <!-- Layer 1.1 Panel -->
    <div id="layer-1.1" class="panel"></div>

    <!-- Layer 1.2 Panel -->
    <div id="layer-1.2" class="panel"></div>

    <!-- Layer 2 Panel -->
    <div id="layer-2" class="panel"></div>

    <!-- Layer 3 Panel -->
    <div id="layer-3" class="panel"></div>

    <!-- Layer 4 Panel -->
    <div id="layer-4" class="panel"></div>

    <!-- Layer 5 Panel -->
    <div id="layer-5" class="panel"></div>

    <!-- Layer 5.1 Panel -->
    <div id="layer-5.1" class="panel"></div>

    <!-- Layer 6 Panel -->
    <div id="layer-6" class="panel"></div>

    <!-- Layer 7 Panel -->
    <div id="layer-7" class="panel"></div>

    <!-- Layer 8 Panel -->
    <div id="layer-8" class="panel"></div>

    <!-- Layer 9 Panel -->
    <div id="layer-9" class="panel"></div>

    <!-- Layer 9.1 Panel -->
    <div id="layer-9.1" class="panel"></div>

    <!-- Layer 10 Panel -->
    <div id="layer-10" class="panel"></div>

    <!-- Layer 11 Panel -->
    <div id="layer-11" class="panel"></div>

    <!-- Layer 12 Panel -->
    <div id="layer-12" class="panel"></div>

    <!-- Layer 13 Panel -->
    <div id="layer-13" class="panel"></div>

  </main>

  <!-- Routing -->
  <script>
    const loadedPanels = new Set(['layer-1']);
    const initializedPanels = new Set();
    let Arena2D = null;

    async function navigateTo(panelId, pushHistory = true) {
      // Update nav active state
      document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
      const link = document.querySelector(`.nav-link[data-panel="${panelId}"]`);
      if (link && !link.classList.contains('disabled')) link.classList.add('active');

      // Update panel visibility
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      const panel = document.getElementById(panelId);
      if (panel) panel.classList.add('active');

      // Update URL hash and history
      if (pushHistory) {
        history.pushState({ panel: panelId }, '', `#${panelId}`);
      }

      // Dynamic demo loading
      if (!initializedPanels.has(panelId)) {
        await initPanel(panelId);
      }
    }

    async function initPanel(panelId) {
      const panel = document.getElementById(panelId);
      if (!panel) return;

      try {
        // Load library if not loaded
        if (!Arena2D) {
          const mod = await import("../dist/arena-2d.js");
          Arena2D = mod;
        }

        // Load panel HTML
        const htmlFilename = `panels/${panelId.replace(/^layer-/, 'layer')}.html`;
        const response = await fetch(htmlFilename);
        if (response.ok) {
          panel.innerHTML = await response.text();
        }

        // Load and init panel JS
        const jsFilename = `./panels/${panelId.replace(/^layer-/, 'layer')}.js?v=${Date.now()}`;
        const module = await import(jsFilename);
        if (module.default) {
          await module.default(Arena2D);
          initializedPanels.add(panelId);
        }
      } catch (err) {
        console.error(`Error initializing panel ${panelId}:`, err);
        const stack = err instanceof Error ? err.stack : String(err);
        panel.innerHTML = `<div class="card" style="border-color: #f06060; color: #f06060;">
          <h3>Failed to load demo</h3>
          <p>${err.message}</p>
          <pre style="background: rgba(240, 96, 96, 0.1); padding: 12px; border-radius: 4px; overflow-x: auto; font-size: 12px; margin-top: 12px;">${stack}</pre>
        </div>`;
      }
    }

    // Nav click handler
    document.querySelectorAll('.nav-link:not(.disabled)').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        navigateTo(link.dataset.panel);
      });
    });

    // Browser back/forward
    window.addEventListener('popstate', (e) => {
      const panelId = e.state?.panel || location.hash.slice(1) || 'layer-1';
      navigateTo(panelId, false);
    });

    // Deep link on page load
    (function() {
      const hash = location.hash.slice(1);
      if (hash && document.getElementById(hash)) {
        navigateTo(hash, false);
      } else {
        navigateTo('layer-1', false);
      }
    })();
  </script>


  <!-- Source View Modal -->
  <div id="source-modal" class="modal-overlay">
    <div class="modal-container">
      <div class="modal-header">
        <div class="modal-title">Source View: <span id="source-filename" style="opacity: 0.6;"></span></div>
        <button class="modal-close" onclick="closeSource()">&times;</button>
      </div>
      <div class="modal-content">
        <pre class="line-numbers"><code id="source-code" class="language-javascript"></code></pre>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>

  <script>
    async function showSource(panelId) {
      const filename = `panels/${panelId.replace(/^layer-/, 'layer')}.js`;
      const modal = document.getElementById('source-modal');
      const codeElem = document.getElementById('source-code');
      const filenameElem = document.getElementById('source-filename');

      filenameElem.textContent = filename;
      codeElem.textContent = 'Loading...';
      modal.classList.add('active');

      try {
        const response = await fetch(filename);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        let code = await response.text();
        
        // Strip export default boilerplate
        code = code.replace(/export default async function\(Arena2D\) \{/, '');
        code = code.replace(/export default function\(Arena2D\) \{/, '');
        // Strip closing brace at the end
        code = code.trim();
        if (code.endsWith('}')) {
          code = code.slice(0, -1);
        }
        
        codeElem.textContent = code.trim();
        Prism.highlightElement(codeElem);
      } catch (err) {
        codeElem.textContent = `Error loading source: ${err.message}\n(Make sure ${filename} exists)`;
      }
    }

    function closeSource() {
      document.getElementById('source-modal').classList.remove('active');
    }

    // Close modal on escape key or clicking outside
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeSource();
    });
    document.getElementById('source-modal').addEventListener('click', (e) => {
      if (e.target.id === 'source-modal') closeSource();
    });

    // Automatic injection of "View Source" link
    const observer = new MutationObserver(() => {
      const headers = document.querySelectorAll('h1, h2');
      headers.forEach(h => {
        // Skip global sidebar header
        if (h.closest('.sidebar-header')) return;

        if (!h.querySelector('.view-source-btn')) {
          // Only sub-panels
          const panel = h.closest('.panel');
          if (panel) {
            const btn = document.createElement('span');
            btn.className = 'view-source-btn';
            btn.textContent = 'View Source';
            btn.title = 'Click to view the JavaScript source for this demo';
            btn.onclick = (e) => {
              e.stopPropagation();
              showSource(panel.id);
            };
            h.appendChild(btn);
          }
        }
      });
    });

    observer.observe(document.querySelector('.main'), { childList: true, subtree: true });
  </script>

  <!-- Live Reload -->
  <script>
    (function() {
      let reconnectTimer;
      function connect() {
        const ws = new WebSocket(`ws://${location.host}/__livereload`);
        ws.onmessage = (e) => {
          if (e.data === 'reload') location.reload();
        };
        ws.onclose = () => {
          clearTimeout(reconnectTimer);
          reconnectTimer = setTimeout(connect, 1000);
        };
        ws.onerror = () => ws.close();
      }
      connect();
    })();
  </script>
</body>
</html>
